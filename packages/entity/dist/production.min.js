import"core-js/modules/es6.regexp.flags";import _isFunction from"lodash/isFunction";import{Map as Map$1,List,fromJS}from"immutable";import"core-js/modules/es6.regexp.to-string";import _isString from"lodash/isString";import moment from"moment";import"core-js/modules/web.dom.iterable";import _mapValues from"lodash/fp/mapValues";import _omitBy from"lodash/fp/omitBy";import _omit from"lodash/fp/omit";import _pick from"lodash/fp/pick";import _compose from"lodash/fp/compose";import qs from"query-string";import settings from"settings";function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),r.forEach(function(e){_defineProperty(t,e,i[e])})}return t}function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};var i,r,a={},s=Object.keys(t);for(r=0;r<s.length;r++)i=s[r],e.indexOf(i)>=0||(a[i]=t[i]);return a}function _objectWithoutProperties(t,e){if(null==t)return{};var i,r,a=_objectWithoutPropertiesLoose(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(r=0;r<s.length;r++)i=s[r],e.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(t,i)&&(a[i]=t[i])}return a}const allowBlank=()=>!1,isRequired=(t,e={})=>e.field.isBlank(t,e)&&"May not be blank",entityValid=(t,e={})=>{const i=e.field.entity.validate(t,e);return!!i&&i.size>0&&Map$1({errors:i,message:e.field.errorMessage,entityError:!0})},mayNotBeBlank=(t,e={})=>{const i=e.flag&&e.field.flags[e.flag],r=!e.field.blank&&isRequired(t,e);if(!i)return r;const a=i(t,e);return r?a&&r:a&&"May not be blank"},isRequiredIf=t=>(e,i)=>t(_objectSpread({value:e},i))&&isRequired(e,i);var AllValidators=Object.freeze({allowBlank:allowBlank,isRequired:isRequired,entityValid:entityValid,mayNotBeBlank:mayNotBeBlank,isRequiredIf:isRequiredIf});class Field{constructor(t={}){Object.assign(this,{blank:!1,many:!1,flags:{},cleaners:[],validators:[],listValidators:[]},t,{defaultValidators:[].concat(t.many||t.blank&&!t.flags?[]:[mayNotBeBlank],t.defaultValidators||[]),defaultListValidators:[].concat(!t.many||t.blank&&!t.flags?[]:[mayNotBeBlank],t.defaultListValidators||[])}),this.validators=this.preventDefaultValidators?this.validators:this.defaultValidators.concat(this.validators),this.listValidators=this.preventDefaultValidators?this.listValidators:this.defaultListValidators.concat(this.listValidators)}asOptions(){return this.options.map(t=>({value:t,label:this.messages[t]}))}asParams(t=null,e){if(null===t)return;return(this.many?t:List([t])).filterNot((t=null)=>null===t).map(t=>this.valueToParam(t,e)).join(",")}clean(t,e){const i=Object.assign({},e,{field:this});return this.cleaners.reduce((t,e)=>e(t,i),t)}dataToRecord(t=null){return List.isList(t)?t.map(this.dataToValue.bind(this)):Array.isArray(t)?List(t.map(this.dataToValue.bind(this))):this.dataToValue(t)}dataToValue(t){return t}default(){return this.many?List():null}getField({name:t}={}){return t?null:this}getOptions(){return this.options||List()}getValue(t,{name:e}={}){return e?null:t}isBlank(t=null){return null===t||(this.many?0===t.size:""===t)}isValid(t,e){return 0===this.validate(t,e).size}optionToString(t){return this.messages[t]||""}recordToData(t){if(!this.local)return List.isList(t)?t.map(this.valueToData.bind(this)).toArray():this.valueToData(t)}toString(t=null){return null===t?"":t.toString()}validate(t,e){const i=(t,i)=>List(i).flatMap(i=>{const r=i(t,Object.assign({},e,{field:this}));return(List.isList(r)?r:List([r])).filter(t=>t).map(t=>_isString(t)?Map$1({message:t}):!0===t?Map$1({message:"Unidentified Error"}):t)}),r=i(t,this.many?this.listValidators:this.validators);if(this.many){const e=t&&t.map(t=>i(t,this.validators));return e&&e.every(t=>0===t.size)?r:r.push(Map$1({listError:!0,message:this.errorListMessage,errors:e}))}return r}valueToParam(t=null){if(null!==t)return this.toString(t)}valueToData(t){return t}}class AnyField extends Field{dataToValue(t=null){return fromJS(t)}valueToData(t){return List.isList(t)||Map$1.isMap(t)?t.toJS():t}}class IdField extends AnyField{constructor(t={}){super(t)}default(){}}class TextField extends AnyField{default(){return this.many?List():""}}_defineProperty(TextField,"type","text");class BooleanField extends AnyField{}_defineProperty(BooleanField,"type","boolean");class CharField extends TextField{}_defineProperty(CharField,"type","char");class DateField extends AnyField{constructor(t){super(Object.assign({dateFormat:"YYYY-MM-DD",allowTime:!1},t))}dataToValue(t=null){return t&&moment(t)}toString(t=null){return null===t?"":t.format(this.dateFormat)}valueToData(t){return t&&this.toString(t)}}_defineProperty(DateField,"type","date");class DateTimeField extends DateField{constructor(t){super(Object.assign({dateFormat:"YYYY-MM-DD HH:mm",allowTime:!0},t))}}class NumberField extends AnyField{}class IntegerField extends NumberField{dataToValue(t=null){const e=parseInt(t,10);return Number.isNaN(e)?null:e}}class EntityField extends AnyField{constructor(t={}){super(Object.assign({},t,!t.preventEntityValidators&&{defaultValidators:[entityValid].concat(t.defaultValidators||[])}))}dataToValue(t){return this.entity.dataToRecord(t)}default(){return this.many?List():this.blank?null:this.entity.dataToRecord({})}getField({name:t}={}){return t&&!Array.isArray(t)?this.entity.fields[t]:this}getFilterParams(){return Map$1()}getValue(t=null,{name:e}={}){if(Array.isArray(e)){const i=e.filter(t=>t in this.entity.fields);return t&&t.filter((t,e)=>i.includes(e))}return e&&t?t.get(e):t}getOptions(){return this.options||this.entity.options||List()}toString(t=null){return null===t?"":this.entity.toString(t)}toStringOrdered(t=null){return null===t?"":this.entity.toStringOrdered(t)}valueToData(t){return this.entity.recordToData(t)}valueToParam(t=null){return null===t?void 0:t.get(this.entity.idField)}}_defineProperty(EntityField,"type","entity");class EntityIdField extends EntityField{constructor(t={}){super(_objectSpread({},t,{preventEntityValidators:!0}))}dataToValue(t=null){return fromJS(t)}default(){}getFilterParamsId(){return Map$1()}valueToData(t){return t}valueToParam(t=null){if(null!==t)return this.toString(t)}}_defineProperty(EntityIdField,"type","entityid");var AllFields=Object.freeze({Field:Field,AnyField:AnyField,IdField:IdField,TextField:TextField,BooleanField:BooleanField,CharField:CharField,DateField:DateField,DateTimeField:DateTimeField,NumberField:NumberField,IntegerField:IntegerField,EntityField:EntityField,EntityIdField:EntityIdField});class Entity{static clean(t,e){const i=Object.assign({},e,{entity:this});return this.cleaners.reduce((t,e)=>e(t,i),t)}static dataToRecord(t=null){if(Map$1.isMap(t))return t;const e=e=>_isFunction(e.default)?e.default({data:t,field:e}):e.default;return t&&_compose(fromJS,t=>_compose(e=>Object.assign({},e,t),_mapValues(e),_omit(Object.keys(t)))(this.fields),e=>_compose(_mapValues.convert({cap:!1})((i,r)=>i.dataToRecord(e[r],{data:t})),_pick(Object.keys(e)))(this.fields),_omitBy(t=>void 0===t),_pick(Object.keys(this.fields)))(t)}static getId(t,{name:e}={}){return e?t&&this.fields[e].entity.getId(t.get(e)):null==t?void 0:t.get(this.idField)}static getExportUrl(t){const e=t.remove("page").remove("page_size").filter(t=>t)||Map$1();return`${settings.BASE_API_URL}${this.apiBase}?${qs.stringify(e.toJS())}&format=xlsx`}static isEntity(t){return!!t&&t.prototype instanceof Entity}static isEntityDescendant(t){return!!t&&t.prototype instanceof this}static isFieldBlank(t,e){let i=e.name,r=e.mapProps,a=void 0===r?{}:r,s=_objectWithoutProperties(e,["name","mapProps"]);const n=a[i]||i;return t&&this.fields[n].isBlank(t.get(n),s)}static isFieldBlankEvery(t,e){let i=e.names,r=e.mapProps,a=void 0===r?{}:r,s=_objectWithoutProperties(e,["names","mapProps"]);const n=i.map(t=>a[t]||t);return t&&n.every(e=>this.fields[e].isBlank(t.get(e),s))}static isFieldBlankSome(t,e){let i=e.names,r=e.mapProps,a=void 0===r?{}:r,s=_objectWithoutProperties(e,["names","mapProps"]);const n=i.map(t=>a[t]||t);return t&&n.some(e=>this.fields[e].isBlank(t.get(e),s))}static isValid(t,e){return 0===this.validate(t,e).size}static optionToString(t){return this.toString(fromJS(t))}static recordToData(t){return Map$1.isMap(t)?t.filter((t,e)=>e in this.fields).map((t,e)=>this.fields[e].recordToData(t)).toObject():t}static select(t,e){if(Array.isArray(e.name)){const i=e.name.filter(t=>t in this.fields);return t&&t.filter((t,e)=>i.includes(e))}return t&&t.get(e.name)}static toEntityField(t){return new EntityField(Object.assign({entity:this},t))}static toLink(t){return`${this.urlBase}${this.getId(t)}`}static toString(t){return(t||Map$1()).get(this.idField,"")}static toStringOrdered(t){return t?`${t.get("order")+1}. ${this.toString(t)}`:""}static validate(t,e={}){return t&&Map$1(e.fields?_pick(e.fields)(this.fields):this.fields).map((i,r)=>i.validate(t.get(r),Object.assign({},_omit(["fields"])(e),{record:t,field:i,name:r,formEntity:this}))).filterNot(t=>0===t.size)}}_defineProperty(Entity,"idField","uuid"),_defineProperty(Entity,"urlBase",""),_defineProperty(Entity,"fields",{}),_defineProperty(Entity,"cleaners",[]);class BaseEntity extends Entity{static actionArchive(t){return t.set("is_archived",!0)}static actionArrayDeleteAtIndex(t,{index:e=null}={}){return t.delete(e)}static actionArrayDeleteAtIndexOrdered(t,e){return this.actionArrayDeleteAtIndex(t,e).map((t,e)=>t.set("order",e))}static actionArrayMoveAtIndex(t,{index:e=null,indexTo:i=null}={}){return t.delete(e).insert(i,t.get(e))}static actionArrayMoveAtIndexOrdered(t,e){return this.actionArrayMoveAtIndex(t,e).map((t,e)=>t.set("order",e))}static actionComplete(t){return t.set("completed",!0)}static actionReset(t){return this.dataToRecord({[this.idField]:t.get(this.idField)})}static actionSave(t){return this.duck.save(t,{invalidateList:!0})}static actionSubmit(t){return t.set("is_draft",!1)}static isOverdue(t){return t.get("is_draft")&&t.get("due_date").isBefore(moment(),"day")}}_defineProperty(BaseEntity,"name","BaseEntity");class FilterEntity extends BaseEntity{static asParams(t,e){return(t||Map$1()).filter((t,e)=>e in this.fields).filterNot((t,e)=>this.fields[e].local).map((t,i)=>this.fields[i].asParams(t,e)).flatten()}}_defineProperty(FilterEntity,"name","FilterEntity"),_defineProperty(FilterEntity,"fields",{page:new IntegerField({default:1}),page_size:new IntegerField({default:20})});class TitleEntity extends BaseEntity{static toString(t){return(t||Map$1()).get("title","")}}_defineProperty(TitleEntity,"name","TitleEntity"),_defineProperty(TitleEntity,"fields",{uuid:new IdField({blank:!0}),title:new CharField,title_short:new CharField({blank:!0}),is_archived:new BooleanField({default:!1})});class EnumEntity extends BaseEntity{static toString(t){return t.get("label")}}_defineProperty(EnumEntity,"idField","value"),_defineProperty(EnumEntity,"fields",{value:new CharField,label:new CharField});class EnumField extends EntityField{constructor(t){super(Object.assign({entity:EnumEntity},t))}dataToValue(t=null){return t&&this.getOptions().find(e=>this.entity.getId(e)===t)}default(){return this.many?List():null}isEnumActive(t,{name:e}){return this.many?t.some(t=>t.get("value")===e):!!t&&t.get("value")===e}valueToData(t=null){return t&&this.entity.getId(t)}valueToParam(t=null){return null===t?void 0:this.entity.getId(t)}}const Fields=Object.assign({EnumField:EnumField},AllFields),Validators=AllValidators;export{Fields,Validators,Entity,BaseEntity,FilterEntity,TitleEntity,EnumEntity};
