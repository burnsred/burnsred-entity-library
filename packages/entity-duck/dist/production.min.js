import exact from"prop-types-exact";import PropTypes from"prop-types";import PropTypesPlus from"@gnowth/prop-types-plus";import React from"react";import _compose from"lodash/fp/compose";import _isFunction from"lodash/fp/isFunction";import _mapValues from"lodash/fp/mapValues";import{handleActions}from"redux-actions";import{Entity}from"@gnowth/entity";import"core-js/modules/es6.regexp.search";import _omit from"lodash/fp/omit";import PropTypesImmutable from"react-immutable-proptypes";import{Map as Map$1}from"immutable";import{connect}from"react-redux";import withPropTypes from"higher-order-component/withPropTypes";import withState from"higher-order-component/withState";import _debounce from"lodash/fp/debounce";import _endsWith from"lodash/fp/endsWith";import axios from"axios";function _defineProperty(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}function _extends(){return(_extends=Object.assign||function(e){for(var o=1;o<arguments.length;o++){var t=arguments[o];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e}).apply(this,arguments)}function _objectSpread(e){for(var o=1;o<arguments.length;o++){var t=null!=arguments[o]?arguments[o]:{},s=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.forEach(function(o){_defineProperty(e,o,t[o])})}return e}function _objectWithoutPropertiesLoose(e,o){if(null==e)return{};var t,s,r={},p=Object.keys(e);for(s=0;s<p.length;s++)t=p[s],o.indexOf(t)>=0||(r[t]=e[t]);return r}function _objectWithoutProperties(e,o){if(null==e)return{};var t,s,r=_objectWithoutPropertiesLoose(e,o);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(s=0;s<p.length;s++)t=p[s],o.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}const _React$createContext=React.createContext({}),Provider=_React$createContext.Provider,DuckConsumer=_React$createContext.Consumer,DuckProvider=e=>{let o=e.children,t=_objectWithoutProperties(e,["children"]);return React.createElement(Provider,{value:t},o)};DuckProvider.propTypes=exact({children:PropTypes.node.isRequired,processingComponent:PropTypesPlus.isRequiredIf("processingComponentProps",PropTypesPlus.component),processingComponentProps:PropTypes.shape({}),processingDidFailComponent:PropTypesPlus.isRequiredIf("processingDidFailComponentProps",PropTypesPlus.component),processingDidFailComponentProps:PropTypes.shape({}),recordsCountComponent:PropTypesPlus.isRequiredIf("recordsCountComponentProps",PropTypesPlus.component),recordsCountComponentProps:PropTypes.shape({}),recordsCountNoneComponent:PropTypesPlus.isRequiredIf("recordsCountNoneComponentProps",PropTypesPlus.component),recordsCountNoneComponentProps:PropTypes.shape({}),store:PropTypes.shape({dispatch:PropTypes.func.isRequired,getState:PropTypes.func.isRequired,subscribe:PropTypes.func.isRequired}).isRequired}),DuckProvider.defaultProps={processingComponent:void 0,processingComponentProps:void 0,processingDidFailComponent:void 0,processingDidFailComponentProps:void 0,recordsCountComponent:void 0,recordsCountComponentProps:void 0,recordsCountNoneComponent:void 0,recordsCountNoneComponentProps:void 0};const withDuck=e=>(function(o){return React.createElement(DuckConsumer,null,t=>React.createElement(e,_extends({},t,o)))});class Duck{static createAction({defaultMeta:e,meta:o=(({options:e})=>e),payload:t=(e=>e.payload)}={}){return({entity:s,keyAction:r})=>p=>(n,i={})=>({type:p,meta:Object.assign({keyAction:r,entity:s},_isFunction(e)?e({entity:s,options:i,payload:n}):e,o({entity:s,options:i,payload:n})),payload:t({entity:s,options:i,payload:n})})}static getInitialState({entity:e}){return e.dataToRecord({})}static toKey(e,o){return t=>`@@${e}/${this.namespace}/${o.name.toUpperCase()}_${t.toUpperCase()}`}constructor(e){const o=_mapValues.convert({cap:!1})((o,t)=>_compose(o({entity:e.entity,keyAction:t}),this.constructor.toKey(e.app,e.entity))(t))(this.constructor.actions);Object.assign(this,o,e)}createReducer(){const e=this.constructor,o=e.getInitialState({entity:this.entity});return _compose(e=>handleActions(e,o),t=>e.getReducers(t,o),_mapValues.convert({cap:!1})((o,t)=>e.toKey(this.app,this.entity)(t)))(e.actions)}}const createDuckRef=e=>({clear:(o,t)=>e.meta.keyClear&&o(e.meta.entity.duck[e.meta.keyClear](t)),pagination:(o,t)=>e.meta.keyPagination&&e.meta.entity.duck[e.meta.keyPagination](o,t),record:(o,t)=>e.meta.keyRecord&&e.meta.entity.duck[e.meta.keyRecord](o,t),save:(o,t,s)=>e.meta.keySave&&o(e.meta.entity.duck[e.meta.keySave](t,s)),status:(o,t)=>!!e.meta.keyStatus&&e.meta.entity.duck[e.meta.keyStatus](o,t)}),mapStateToProps=(e,o)=>{const t=o.withQueryDuckContainer_state.action||o.action({search:o.withQueryDuckContainer_state.search}),s=createDuckRef(t);return Object.assign({action:t,duckRef:s,params:t.meta.params,entity:t.meta.entity,initialValue:s.record(e,t.meta),inputValue:o.withQueryDuckContainer_state.search,isProcessing:e=>s.status(e,_objectSpread({},t.meta,{status:t.meta.keyProcessing})),processing:s.status(e,_objectSpread({},t.meta,{status:t.meta.keyProcessing})),processingDidFail:s.status(e,_objectSpread({},t.meta,{status:t.meta.keyProcessingDidFail})),value:s.record(e,_objectSpread({},t.meta,{dirty:!0}))},void 0===t.meta.id&&t.meta.entity.paginated&&{pagination:s.pagination(e,t.meta)})},mergeProps=(e,o,t)=>Object.assign({},_omit(["withQueryDuckContainer_setState","withQueryDuckContainer_state"])(t),e,o,{clear:t=>e.duckRef.clear(o.dispatch,_objectSpread({},e.action.meta,t)),onInputChange:e=>t.withQueryDuckContainer_setState({search:e}),process:()=>!e.processing&&!e.processingDidFail&&o.dispatch(t.action({search:t.withQueryDuckContainer_state.search})),save:t=>e.duckRef.save(o.dispatch,t,_objectSpread({},e.action.meta,{dirty:!0}))});var withQueryDuckContainer=_compose(withPropTypes({displayName:"QueryDuckContainer",propTypes:exact({action:PropTypes.func.isRequired,children:PropTypes.func,component:PropTypesPlus.component,componentProps:PropTypes.shape({}),filterParams:PropTypesImmutable.map}),defaultProps:{children:void 0,componentProps:void 0,filterParams:Map$1()}}),withState({initialState:{action:void 0,search:""},mapProps:{state:"withQueryDuckContainer_state",setState:"withQueryDuckContainer_setState"}}),connect(mapStateToProps,null,mergeProps),withDuck);class QueryDuck extends React.Component{constructor(...e){super(...e),_defineProperty(this,"handleChange",({target:{index:e,name:o,value:t}})=>this.props.save(void 0===e?t:this.props.value.set(e,t))),_defineProperty(this,"handleInputChange",_debounce(500)(this.props.onInputChange))}componentDidMount(){!(this.props.isProcessing(this.props.store.getState())||this.props.value&&this.props.cached)&&this.props.process()}componentDidUpdate(){!this.props.isProcessing(this.props.store.getState())&&!this.props.value&&this.props.process()}componentWillUnmount(){this.props.persist||this.props.clear(),this.props.persist&&!this.props.persistDirty&&this.props.clear({dirty:!0})}getProps(){return Object.assign({field:this.props.entity.toEntityField(),initialValue:this.props.initialValue,inputValue:this.props.inputValue,name:this.props.name,onChange:this.handleChange,onInputChange:this.handleInputChange,value:this.props.value},!this.props.shouldProcess&&{processing:this.props.processing,processingDidFail:this.props.processingDidFail})}renderAsComponent(e){return React.createElement(React.Fragment,null,this.props.shouldProcess&&this.props.processing&&this.props.processingComponent&&React.createElement(this.props.processingComponent,this.props.processingComponentProps||{}),this.props.shouldProcess&&this.props.processingDidFail&&this.props.processingDidFailComponent&&React.createElement(this.props.processingDidFailComponent,this.props.processingDidFailComponentProps||{}),this.props.shouldProcess&&!this.props.processing&&!this.props.processingDidFail&&!this.props.recordsCountHidden&&void 0!==this.props.value&&React.createElement(this.props.recordsCountComponent,_extends({value:this.props.entity.paginated&&this.props.pagination?this.props.pagination.get("count"):this.props.value.size},this.props.recordsCountComponentProps||{})),this.props.shouldProcess&&!this.props.processing&&!this.props.processingDidFail&&!this.props.recordsCountHidden&&void 0!==this.props.value&&React.createElement(this.props.recordsCountNoneComponent,this.props.recordsCountNoneComponentProps||{}),this.props.shouldProcess&&!this.props.processing&&!this.props.processingDidFail&&void 0!==this.props.value&&(this.props.many?this.renderComponentArray(e):this.renderComponent(e)),!this.props.shouldProcess&&this.renderComponent(e))}renderComponent(e){return React.createElement(this.props.component,_extends({},e,_isFunction(this.props.componentProps)?this.props.componentProps(e):this.props.componentProps||{}))}renderComponentArray(e){return e.value.map((o,t)=>{var s,r;return React.createElement(this.props.component,_extends({key:this.props.entity.getId(o)},e,{index:t,initialValue:null===(s=e.initialValue)||void 0===s?void 0:s.get(t),records:e.value,value:o},_isFunction(this.props.componentProps)?this.props.componentProps(Object.assign({},e,{index:t,initialValue:null===(r=e.initialValue)||void 0===r?void 0:r.get(t),records:e.value,value:o})):this.props.componentProps||{}))})}render(){return this.props.children?this.props.children(this.getProps()):this.renderAsComponent(this.getProps())}}QueryDuck.propTypes={cached:PropTypes.bool,children:PropTypesPlus.isRequiredIfNot("component",PropTypes.func),clear:PropTypes.func.isRequired,entity:PropTypes.shape({duck:PropTypes.instanceOf(Duck),prototype:PropTypes.instanceOf(Entity)}).isRequired,component:PropTypesPlus.isRequiredIf("componentProps",PropTypesPlus.component),componentProps:PropTypes.shape({}),id:PropTypes.string,initialValue:PropTypes.oneOfType([PropTypesImmutable.list,PropTypesImmutable.map]),inputValue:PropTypes.string,isProcessing:PropTypes.func.isRequired,many:PropTypes.bool,name:PropTypes.string,onInputChange:PropTypes.func.isRequired,pagination:PropTypesImmutable.map,params:PropTypesImmutable.map.isRequired,persist:PropTypes.bool,persistDirty:PropTypes.bool,process:PropTypes.func.isRequired,processing:PropTypes.bool.isRequired,processingComponent:PropTypesPlus.isRequiredIf("processingComponentProps",PropTypesPlus.component),processingComponentProps:PropTypes.shape({}),processingDidFail:PropTypes.bool.isRequired,processingDidFailComponent:PropTypesPlus.isRequiredIf("processingDidFailComponentProps",PropTypesPlus.component),processingDidFailComponentProps:PropTypes.shape({}),recordsCountComponent:PropTypesPlus.isRequiredIf("recordsCountComponentProps",PropTypesPlus.component),recordsCountComponentProps:PropTypes.shape({}),recordsCountHidden:PropTypes.bool,recordsCountNoneComponent:PropTypesPlus.isRequiredIf("recordsCountNoneComponentProps",PropTypesPlus.component),recordsCountNoneComponentProps:PropTypes.shape({}),save:PropTypes.func.isRequired,shouldProcess:PropTypes.bool,store:PropTypes.shape({dispatch:PropTypes.func.isRequired,getState:PropTypes.func.isRequired,subscribe:PropTypes.func.isRequired}).isRequired,value:PropTypes.oneOfType([PropTypesImmutable.list,PropTypesImmutable.map])},QueryDuck.defaultProps={cached:!0,children:void 0,component:void 0,componentProps:void 0,id:void 0,initialValue:void 0,inputValue:"",many:void 0,name:"query_duck",pagination:void 0,persist:!0,persistDirty:void 0,processingComponent:void 0,processingComponentProps:void 0,processingDidFailComponent:void 0,processingDidFailComponentProps:void 0,recordsCountComponent:void 0,recordsCountComponentProps:void 0,recordsCountHidden:!1,recordsCountNoneComponent:void 0,recordsCountNoneComponentProps:void 0,shouldProcess:!1,value:void 0};var queryDuck=withQueryDuckContainer(QueryDuck);const handleResponse=(e,o)=>t=>{o(e.meta.entity.duck[`${e.meta.keyAction}_resolved`](t.data,Object.assign({payload:e.payload},e.meta))),_isFunction(e.meta.then)&&e.meta.then(_objectSpread({},e,{response:t}))},handleError=(e,o)=>t=>{o(e.meta.entity.duck[`${e.meta.keyAction}_rejected`](t,Object.assign({payload:e.payload},e.meta))),_isFunction(e.meta.catch)&&e.meta.catch(_objectSpread({},e,{error:t}))};var middleware=e=>o=>t=>{var s,r,p;if(!(null===(s=t.meta)||void 0===s?void 0:s.useEntityMiddleware)||_endsWith("_RESOLVED")(t.type)||_endsWith("_REJECTED")(t.type)||!((null===(r=t.meta)||void 0===r?void 0:null===(p=r.entity)||void 0===p?void 0:p.duck)instanceof Duck))return o(t);const n=t.meta.action?`${t.meta.action}/`:"",i=[t.meta.id?`${t.meta.entity.apiBase}${t.meta.id}/${n}`:`${t.meta.entity.apiBase}${n}`,...t.payload?[t.meta.entity.recordToData(t.payload)]:[],{params:t.meta.params&&t.meta.params.filter(e=>e).toJS()}];return axios[t.meta.method].apply(null,i).then(handleResponse(t,e.dispatch)).catch(handleError(t,e.dispatch)),o(t)};export{Duck,queryDuck as QueryDuck,middleware as duckMiddleware,Provider,DuckConsumer,DuckProvider,withDuck};
