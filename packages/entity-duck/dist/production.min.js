import objectAssign from"object-assign";import"prop-types/checkPropTypes";import exact from"prop-types-exact";import PropTypes from"prop-types";import PropTypesPlus from"@gnowth/prop-types-lus";import _compose from"lodash/fp/compose";import _isFunction from"lodash/fp/isFunction";import _mapValues from"lodash/fp/mapValues";import{handleActions}from"redux-actions";import{Entity}from"@gnowth/entity";import"core-js/modules/es6.regexp.search";import _omit from"lodash/fp/omit";import PropTypesImmutable from"react-immutable-proptypes";import PropTypesPlus$1 from"@gnowth/prop-types-plus";import{Map as Map$1}from"immutable";import{connect}from"react-redux";import withPropTypes from"higher-order-component/withPropTypes";import withState from"higher-order-component/withState";import _debounce from"lodash/fp/debounce";import _endsWith from"lodash/fp/endsWith";import axios from"axios";function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e}).apply(this,arguments)}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},r=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),r.forEach(function(t){_defineProperty(e,t,o[t])})}return e}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var o,r,n={},s=Object.keys(e);for(r=0;r<s.length;r++)o=s[r],t.indexOf(o)>=0||(n[o]=e[o]);return n}function _objectWithoutProperties(e,t){if(null==e)return{};var o,r,n=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)o=s[r],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var n="function"==typeof Symbol&&Symbol.for,p=n?Symbol.for("react.element"):60103,q=n?Symbol.for("react.portal"):60106,r=n?Symbol.for("react.fragment"):60107,t=n?Symbol.for("react.strict_mode"):60108,u=n?Symbol.for("react.profiler"):60114,v=n?Symbol.for("react.provider"):60109,w=n?Symbol.for("react.context"):60110,x=n?Symbol.for("react.async_mode"):60111,y=n?Symbol.for("react.forward_ref"):60112,z="function"==typeof Symbol&&Symbol.iterator;function A(e,t,o,r,n,s,p,i){if(!e){if(e=void 0,void 0===t)e=Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var a=[o,r,n,s,p,i],c=0;(e=Error(t.replace(/%s/g,function(){return a[c++]}))).name="Invariant Violation"}throw e.framesToPop=1,e}}function B(e){for(var t=arguments.length-1,o="https://reactjs.org/docs/error-decoder.html?invariant="+e,r=0;r<t;r++)o+="&args[]="+encodeURIComponent(arguments[r+1]);A(!1,"Minified React error #"+e+"; visit %s for the full message or use the non-minified dev environment for full errors and additional helpful warnings. ",o)}var C={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},D={};function E(e,t,o){this.props=e,this.context=t,this.refs=D,this.updater=o||C}function F(){}function G(e,t,o){this.props=e,this.context=t,this.refs=D,this.updater=o||C}E.prototype.isReactComponent={},E.prototype.setState=function(e,t){"object"!=typeof e&&"function"!=typeof e&&null!=e&&B("85"),this.updater.enqueueSetState(this,e,t,"setState")},E.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},F.prototype=E.prototype;var H=G.prototype=new F;H.constructor=G,objectAssign(H,E.prototype),H.isPureReactComponent=!0;var I={current:null,currentDispatcher:null},J=Object.prototype.hasOwnProperty,K={key:!0,ref:!0,__self:!0,__source:!0};function L(e,t,o){var r=void 0,n={},s=null,i=null;if(null!=t)for(r in void 0!==t.ref&&(i=t.ref),void 0!==t.key&&(s=""+t.key),t)J.call(t,r)&&!K.hasOwnProperty(r)&&(n[r]=t[r]);var a=arguments.length-2;if(1===a)n.children=o;else if(1<a){for(var c=Array(a),u=0;u<a;u++)c[u]=arguments[u+2];n.children=c}if(e&&e.defaultProps)for(r in a=e.defaultProps)void 0===n[r]&&(n[r]=a[r]);return{$$typeof:p,type:e,key:s,ref:i,props:n,_owner:I.current}}function M(e,t){return{$$typeof:p,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}function N(e){return"object"==typeof e&&null!==e&&e.$$typeof===p}function escape(e){var t={"=":"=0",":":"=2"};return"$"+(""+e).replace(/[=:]/g,function(e){return t[e]})}var O=/\/+/g,P=[];function Q(e,t,o,r){if(P.length){var n=P.pop();return n.result=e,n.keyPrefix=t,n.func=o,n.context=r,n.count=0,n}return{result:e,keyPrefix:t,func:o,context:r,count:0}}function R(e){e.result=null,e.keyPrefix=null,e.func=null,e.context=null,e.count=0,10>P.length&&P.push(e)}function S(e,t,o,r){var n=typeof e;"undefined"!==n&&"boolean"!==n||(e=null);var s=!1;if(null===e)s=!0;else switch(n){case"string":case"number":s=!0;break;case"object":switch(e.$$typeof){case p:case q:s=!0}}if(s)return o(r,e,""===t?"."+T(e,0):t),1;if(s=0,t=""===t?".":t+":",Array.isArray(e))for(var i=0;i<e.length;i++){var a=t+T(n=e[i],i);s+=S(n,a,o,r)}else if(null===e||"object"!=typeof e?a=null:a="function"==typeof(a=z&&e[z]||e["@@iterator"])?a:null,"function"==typeof a)for(e=a.call(e),i=0;!(n=e.next()).done;)s+=S(n=n.value,a=t+T(n,i++),o,r);else"object"===n&&B("31","[object Object]"===(o=""+e)?"object with keys {"+Object.keys(e).join(", ")+"}":o,"");return s}function U(e,t,o){return null==e?0:S(e,"",t,o)}function T(e,t){return"object"==typeof e&&null!==e&&null!=e.key?escape(e.key):t.toString(36)}function V(e,t){e.func.call(e.context,t,e.count++)}function aa(e,t,o){var r=e.result,n=e.keyPrefix;e=e.func.call(e.context,t,e.count++),Array.isArray(e)?W(e,r,o,function(e){return e}):null!=e&&(N(e)&&(e=M(e,n+(!e.key||t&&t.key===e.key?"":(""+e.key).replace(O,"$&/")+"/")+o)),r.push(e))}function W(e,t,o,r,n){var s="";null!=o&&(s=(""+o).replace(O,"$&/")+"/"),U(e,aa,t=Q(t,s,r,n)),R(t)}function ba(e,t){var o=I.currentDispatcher;return null===o&&B("277"),o.readContext(e,t)}var X={Children:{map:function(e,t,o){if(null==e)return e;var r=[];return W(e,r,null,t,o),r},forEach:function(e,t,o){if(null==e)return e;U(e,V,t=Q(null,null,t,o)),R(t)},count:function(e){return U(e,function(){return null},null)},toArray:function(e){var t=[];return W(e,t,null,function(e){return e}),t},only:function(e){return N(e)||B("143"),e}},createRef:function(){return{current:null}},Component:E,PureComponent:G,createContext:function(e,t){return void 0===t&&(t=null),(e={$$typeof:w,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,Provider:null,Consumer:null,unstable_read:null}).Provider={$$typeof:v,_context:e},e.Consumer=e,e.unstable_read=ba.bind(null,e),e},forwardRef:function(e){return{$$typeof:y,render:e}},Fragment:r,StrictMode:t,unstable_AsyncMode:x,unstable_Profiler:u,createElement:L,cloneElement:function(e,t,o){null==e&&B("267",e);var r=void 0,n=objectAssign({},e.props),s=e.key,i=e.ref,a=e._owner;if(null!=t){void 0!==t.ref&&(i=t.ref,a=I.current),void 0!==t.key&&(s=""+t.key);var c=void 0;for(r in e.type&&e.type.defaultProps&&(c=e.type.defaultProps),t)J.call(t,r)&&!K.hasOwnProperty(r)&&(n[r]=void 0===t[r]&&void 0!==c?c[r]:t[r])}if(1===(r=arguments.length-2))n.children=o;else if(1<r){c=Array(r);for(var u=0;u<r;u++)c[u]=arguments[u+2];n.children=c}return{$$typeof:p,type:e.type,key:s,ref:i,props:n,_owner:a}},createFactory:function(e){var t=L.bind(null,e);return t.type=e,t},isValidElement:N,version:"16.5.1",__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:{ReactCurrentOwner:I,assign:objectAssign}},Y={default:X},Z=Y&&X||Y,react_production_min=Z.default||Z,react_development=createCommonjsModule(function(e){}),react=createCommonjsModule(function(e){e.exports=react_production_min});const _React$createContext=react.createContext({}),Provider=_React$createContext.Provider,DuckConsumer=_React$createContext.Consumer,DuckProvider=e=>{let t=e.children,o=_objectWithoutProperties(e,["children"]);return react.createElement(Provider,{value:o},t)};DuckProvider.propTypes=exact({children:PropTypes.node.isRequired,processingComponent:PropTypesPlus.isRequiredIf("processingComponentProps",PropTypesPlus.component),processingComponentProps:PropTypes.shape({}),processingDidFailComponent:PropTypesPlus.isRequiredIf("processingDidFailComponentProps",PropTypesPlus.component),processingDidFailComponentProps:PropTypes.shape({}),recordsCountComponent:PropTypesPlus.isRequiredIf("recordsCountComponentProps",PropTypesPlus.component),recordsCountComponentProps:PropTypes.shape({}),recordsCountNoneComponent:PropTypesPlus.isRequiredIf("recordsCountNoneComponentProps",PropTypesPlus.component),recordsCountNoneComponentProps:PropTypes.shape({}),store:PropTypes.shape({dispatch:PropTypes.func.isRequired,getState:PropTypes.func.isRequired,subscribe:PropTypes.func.isRequired}).isRequired}),DuckProvider.defaultProps={processingComponent:void 0,processingComponentProps:void 0,processingDidFailComponent:void 0,processingDidFailComponentProps:void 0,recordsCountComponent:void 0,recordsCountComponentProps:void 0,recordsCountNoneComponent:void 0,recordsCountNoneComponentProps:void 0};const withDuck=e=>(function(t){return react.createElement(DuckConsumer,null,o=>react.createElement(e,_extends({},o,t)))});class Duck{static createAction({defaultMeta:e,meta:t=(({options:e})=>e),payload:o=(e=>e.payload)}={}){return({entity:r,keyAction:n})=>s=>(p,i={})=>({type:s,meta:Object.assign({keyAction:n,entity:r},_isFunction(e)?e({entity:r,options:i,payload:p}):e,t({entity:r,options:i,payload:p})),payload:o({entity:r,options:i,payload:p})})}static getInitialState({entity:e}){return e.dataToRecord({})}static toKey(e,t){return o=>`@@${e}/${this.namespace}/${t.name.toUpperCase()}_${o.toUpperCase()}`}constructor(e){const t=_mapValues.convert({cap:!1})((t,o)=>_compose(t({entity:e.entity,keyAction:o}),this.constructor.toKey(e.app,e.entity))(o))(this.constructor.actions);Object.assign(this,t,e)}createReducer(){const e=this.constructor,t=e.getInitialState({entity:this.entity});return _compose(e=>handleActions(e,t),o=>e.getReducers(o,t),_mapValues.convert({cap:!1})((t,o)=>e.toKey(this.app,this.entity)(o)))(e.actions)}}const createDuckRef=e=>({clear:(t,o)=>e.meta.keyClear&&t(e.meta.entity.duck[e.meta.keyClear](o)),pagination:(t,o)=>e.meta.keyPagination&&e.meta.entity.duck[e.meta.keyPagination](t,o),record:(t,o)=>e.meta.keyRecord&&e.meta.entity.duck[e.meta.keyRecord](t,o),save:(t,o,r)=>e.meta.keySave&&t(e.meta.entity.duck[e.meta.keySave](o,r)),status:(t,o)=>!!e.meta.keyStatus&&e.meta.entity.duck[e.meta.keyStatus](t,o)}),mapStateToProps=(e,t)=>{const o=t.withQueryDuckContainer_state.action||t.action({search:t.withQueryDuckContainer_state.search}),r=createDuckRef(o);return Object.assign({action:o,duckRef:r,params:o.meta.params,entity:o.meta.entity,initialValue:r.record(e,o.meta),inputValue:t.withQueryDuckContainer_state.search,isProcessing:e=>r.status(e,_objectSpread({},o.meta,{status:o.meta.keyProcessing})),processing:r.status(e,_objectSpread({},o.meta,{status:o.meta.keyProcessing})),processingDidFail:r.status(e,_objectSpread({},o.meta,{status:o.meta.keyProcessingDidFail})),value:r.record(e,_objectSpread({},o.meta,{dirty:!0}))},void 0===o.meta.id&&o.meta.entity.paginated&&{pagination:r.pagination(e,o.meta)})},mergeProps=(e,t,o)=>Object.assign({},_omit(["withQueryDuckContainer_setState","withQueryDuckContainer_state"])(o),e,t,{clear:o=>e.duckRef.clear(t.dispatch,_objectSpread({},e.action.meta,o)),onInputChange:e=>o.withQueryDuckContainer_setState({search:e}),process:()=>!e.processing&&!e.processingDidFail&&t.dispatch(o.action({search:o.withQueryDuckContainer_state.search})),save:o=>e.duckRef.save(t.dispatch,o,_objectSpread({},e.action.meta,{dirty:!0}))});var withQueryDuckContainer=_compose(withPropTypes({displayName:"QueryDuckContainer",propTypes:exact({action:PropTypes.func.isRequired,children:PropTypes.func,component:PropTypesPlus$1.component,componentProps:PropTypes.shape({}),filterParams:PropTypesImmutable.map}),defaultProps:{children:void 0,componentProps:void 0,filterParams:Map$1()}}),withState({initialState:{action:void 0,search:""},mapProps:{state:"withQueryDuckContainer_state",setState:"withQueryDuckContainer_setState"}}),connect(mapStateToProps,null,mergeProps),withDuck);class QueryDuck extends react.Component{constructor(...e){super(...e),_defineProperty(this,"handleChange",({target:{index:e,name:t,value:o}})=>this.props.save(void 0===e?o:this.props.value.set(e,o))),_defineProperty(this,"handleInputChange",_debounce(500)(this.props.onInputChange))}componentDidMount(){!(this.props.isProcessing(this.props.store.getState())||this.props.value&&this.props.cached)&&this.props.process()}componentDidUpdate(){!this.props.isProcessing(this.props.store.getState())&&!this.props.value&&this.props.process()}componentWillUnmount(){this.props.persist||this.props.clear(),this.props.persist&&!this.props.persistDirty&&this.props.clear({dirty:!0})}getProps(){return Object.assign({field:this.props.entity.toEntityField(),initialValue:this.props.initialValue,inputValue:this.props.inputValue,name:this.props.name,onChange:this.handleChange,onInputChange:this.handleInputChange,value:this.props.value},!this.props.shouldProcess&&{processing:this.props.processing,processingDidFail:this.props.processingDidFail})}renderAsComponent(e){return react.createElement(react.Fragment,null,this.props.shouldProcess&&this.props.processing&&this.props.processingComponent&&react.createElement(this.props.processingComponent,this.props.processingComponentProps||{}),this.props.shouldProcess&&this.props.processingDidFail&&this.props.processingDidFailComponent&&react.createElement(this.props.processingDidFailComponent,this.props.processingDidFailComponentProps||{}),this.props.shouldProcess&&!this.props.processing&&!this.props.processingDidFail&&!this.props.recordsCountHidden&&void 0!==this.props.value&&react.createElement(this.props.recordsCountComponent,_extends({value:this.props.entity.paginated&&this.props.pagination?this.props.pagination.get("count"):this.props.value.size},this.props.recordsCountComponentProps||{})),this.props.shouldProcess&&!this.props.processing&&!this.props.processingDidFail&&!this.props.recordsCountHidden&&void 0!==this.props.value&&react.createElement(this.props.recordsCountNoneComponent,this.props.recordsCountNoneComponentProps||{}),this.props.shouldProcess&&!this.props.processing&&!this.props.processingDidFail&&void 0!==this.props.value&&(this.props.many?this.renderComponentArray(e):this.renderComponent(e)),!this.props.shouldProcess&&this.renderComponent(e))}renderComponent(e){return react.createElement(this.props.component,_extends({},e,_isFunction(this.props.componentProps)?this.props.componentProps(e):this.props.componentProps||{}))}renderComponentArray(e){return e.value.map((t,o)=>{var r,n;return react.createElement(this.props.component,_extends({key:this.props.entity.getId(t)},e,{index:o,initialValue:null===(r=e.initialValue)||void 0===r?void 0:r.get(o),records:e.value,value:t},_isFunction(this.props.componentProps)?this.props.componentProps(Object.assign({},e,{index:o,initialValue:null===(n=e.initialValue)||void 0===n?void 0:n.get(o),records:e.value,value:t})):this.props.componentProps||{}))})}render(){return this.props.children?this.props.children(this.getProps()):this.renderAsComponent(this.getProps())}}QueryDuck.propTypes={cached:PropTypes.bool,children:PropTypesPlus$1.isRequiredIfNot("component",PropTypes.func),clear:PropTypes.func.isRequired,entity:PropTypes.shape({duck:PropTypes.instanceOf(Duck),prototype:PropTypes.instanceOf(Entity)}).isRequired,component:PropTypesPlus$1.isRequiredIf("componentProps",PropTypesPlus$1.component),componentProps:PropTypes.shape({}),id:PropTypes.string,initialValue:PropTypes.oneOfType([PropTypesImmutable.list,PropTypesImmutable.map]),inputValue:PropTypes.string,isProcessing:PropTypes.func.isRequired,many:PropTypes.bool,name:PropTypes.string,onInputChange:PropTypes.func.isRequired,pagination:PropTypesImmutable.map,params:PropTypesImmutable.map.isRequired,persist:PropTypes.bool,persistDirty:PropTypes.bool,process:PropTypes.func.isRequired,processing:PropTypes.bool.isRequired,processingComponent:PropTypesPlus$1.isRequiredIf("processingComponentProps",PropTypesPlus$1.component),processingComponentProps:PropTypes.shape({}),processingDidFail:PropTypes.bool.isRequired,processingDidFailComponent:PropTypesPlus$1.isRequiredIf("processingDidFailComponentProps",PropTypesPlus$1.component),processingDidFailComponentProps:PropTypes.shape({}),recordsCountComponent:PropTypesPlus$1.isRequiredIf("recordsCountComponentProps",PropTypesPlus$1.component),recordsCountComponentProps:PropTypes.shape({}),recordsCountHidden:PropTypes.bool,recordsCountNoneComponent:PropTypesPlus$1.isRequiredIf("recordsCountNoneComponentProps",PropTypesPlus$1.component),recordsCountNoneComponentProps:PropTypes.shape({}),save:PropTypes.func.isRequired,shouldProcess:PropTypes.bool,store:PropTypes.shape({dispatch:PropTypes.func.isRequired,getState:PropTypes.func.isRequired,subscribe:PropTypes.func.isRequired}).isRequired,value:PropTypes.oneOfType([PropTypesImmutable.list,PropTypesImmutable.map])},QueryDuck.defaultProps={cached:!0,children:void 0,component:void 0,componentProps:void 0,id:void 0,initialValue:void 0,inputValue:"",many:void 0,name:"query_duck",pagination:void 0,persist:!0,persistDirty:void 0,processingComponent:void 0,processingComponentProps:void 0,processingDidFailComponent:void 0,processingDidFailComponentProps:void 0,recordsCountComponent:void 0,recordsCountComponentProps:void 0,recordsCountHidden:!1,recordsCountNoneComponent:void 0,recordsCountNoneComponentProps:void 0,shouldProcess:!1,value:void 0};var queryDuck=withQueryDuckContainer(QueryDuck);const handleResponse=(e,t)=>o=>{t(e.meta.entity.duck[`${e.meta.keyAction}_resolved`](o.data,Object.assign({payload:e.payload},e.meta))),_isFunction(e.meta.then)&&e.meta.then(_objectSpread({},e,{response:o}))},handleError=(e,t)=>o=>{t(e.meta.entity.duck[`${e.meta.keyAction}_rejected`](o,Object.assign({payload:e.payload},e.meta))),_isFunction(e.meta.catch)&&e.meta.catch(_objectSpread({},e,{error:o}))};var middleware=e=>t=>o=>{var r,n,s;if(!(null===(r=o.meta)||void 0===r?void 0:r.useEntityMiddleware)||_endsWith("_RESOLVED")(o.type)||_endsWith("_REJECTED")(o.type)||!((null===(n=o.meta)||void 0===n?void 0:null===(s=n.entity)||void 0===s?void 0:s.duck)instanceof Duck))return t(o);const p=o.meta.action?`${o.meta.action}/`:"",i=[o.meta.id?`${o.meta.entity.apiBase}${o.meta.id}/${p}`:`${o.meta.entity.apiBase}${p}`,...o.payload?[o.meta.entity.recordToData(o.payload)]:[],{params:o.meta.params&&o.meta.params.filter(e=>e).toJS()}];return axios[o.meta.method].apply(null,i).then(handleResponse(o,e.dispatch)).catch(handleError(o,e.dispatch)),t(o)};export{Duck,queryDuck as QueryDuck,middleware as duckMiddleware,Provider,DuckConsumer,DuckProvider,withDuck};
