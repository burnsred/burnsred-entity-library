import{fromJS,List,Map as Map$1}from"immutable";import{stringify}from"query-string";import{Duck}from"@gnowth/entity-duck";function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),r.forEach(function(e){_defineProperty(t,e,i[e])})}return t}const getIdentifier=({id:t="",tag:e="",params:i,method:r,action:a,useId:s})=>{if(s&&""!==t)return null===t?"id_null":t;const n=stringify(i&&i.filter(t=>t).toJS());return`${r}${a?`.${a}`:""}${e?`.${e}`:""}${null===t?".id_null":`.${t}`}${n&&`.${n}`}`},parseError=t=>{const e={status:t.response.status,nonFieldErrors:[],errors:{}};return 0===t.response.status?e.nonFieldErrors=["A fatal error occurred."]:401===t.response.status||403===t.response.status?e.nonFieldErrors=[t.response.data.detail||t.response.data]:404===t.response.status?e.nonFieldErrors=["Not found."]:t.response.status>=500&&t.response.status<600?e.nonFieldErrors=["A server error occurred."]:t.response.data.non_field_errors?e.nonFieldErrors=t.response.data.non_field_errors:e.errors=t.response.data,fromJS(e)};var reducerClear=(t,e)=>({[t.clear]:(t,i)=>{const r=getIdentifier(i.meta);return i.meta.dirty?t.setIn(["detail_dirty",r],t.getIn(["detail",r])):t.withMutations(t=>t.setIn(["detail",r],e.getIn(["detail",r])).setIn(["detail_dirty",r],e.getIn(["detail",r])))}});const getDataFactory=(t,e)=>e.dataToRecord(t),listDataFactory=(t,e)=>e.paginated?fromJS(_objectSpread({},t,{count:parseInt(t.count,10),results:t.results.map(t=>e.dataToRecord(t))})):t.map(t=>e.dataToRecord(t));var reducerGet=t=>({[t.get]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["errors",i],void 0).setIn(["status","getting",i],!0).setIn(["status","gettingDidFail",i],!1))},[t.get_resolved]:(t,e)=>{const i=getIdentifier(e.meta),r=e.meta.id?getDataFactory:listDataFactory;return t.withMutations(t=>t.updateIn(e.meta.id?["detail",e.meta.id]:["list",i],t=>e.meta.skipStore?t:fromJS(r(e.payload,e.meta.entity))).updateIn(e.meta.id?["detail_dirty",e.meta.id]:["list_dirty",i],t=>e.meta.skipStore?t:fromJS(r(e.payload,e.meta.entity))).setIn(["status","getting",i],!1))},[t.get_rejected]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["errors",i],e.payload).setIn(["status","getting",i],!1).setIn(["status","gettingDidFail",i],!0))}}),reducerOptions=t=>({[t.options]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["status","optioning",i],!0).setIn(["status","optioningDidFail",i],!1))},[t.options_resolved]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["errors",i],null).setIn(["options",i],fromJS(e.payload)).setIn(["status","optioning",i],!1))},[t.options_rejected]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["errors",i],parseError(e.payload)).setIn(["status","optioning",i],!1).setIn(["status","optioningDidFail",i],!0))}}),reducerSave=(t,e)=>({[t.save]:(t,e)=>{const i=getIdentifier(e.meta),r=getIdentifier(_objectSpread({},e.meta,{useId:!0}));return t.withMutations(t=>t.updateIn(["detail_dirty",r],t=>e.meta.dirty?e.payload:t).setIn(["status","saving",i],!0).setIn(["status","savingDidFail",i],!1))},[t.save_resolved]:(t,i)=>{const r=getIdentifier(i.meta),a=getIdentifier(_objectSpread({},i.meta,{useId:!0})),s=i.meta.entity.dataToRecord(i.payload);return console.log("idIdentifier",a,i),t.withMutations(n=>n.updateIn(["detail",a],t=>i.meta.skipStore?t:s).setIn(["detail_dirty",a],i.meta.skipStore?t.getIn(["detail",a]):s).setIn(["errors",r],null).setIn(["status","saving",r],!1).update("list",t=>i.meta.invalidateList?e.get("list"):t).update("list_dirty",t=>i.meta.invalidateList?e.get("list_dirty"):t))},[t.save_rejected]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["errors",i],parseError(e.payload)).setIn(["status","saving",i],!1).setIn(["status","savingDidFail",i],!0))}}),reducerDelete=(t,e)=>({[t.delete]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["status","deleting",i],!0).setIn(["status","deletingDidFail",i],!1))},[t.delete_resolved]:(t,i)=>{const r=getIdentifier(i.meta),a=getIdentifier(_objectSpread({},i.meta,{useId:!0}));return t.withMutations(t=>t.deleteIn(["detail",a]).deleteIn(["detail_dirty",a]).setIn(["errors",r],null).setIn(["status","deleting",r],!1).update("list",t=>i.meta.invalidateList?e.get("list"):t).update("list_dirty",t=>i.meta.invalidateList?e.get("list_dirty"):t))},[t.delete_rejected]:(t,e)=>{const i=getIdentifier(e.meta);return t.withMutations(t=>t.setIn(["errors",i],parseError(e.payload)).setIn(["status","deleting",i],!1).setIn(["status","deletingDidFail",i],!0))}});class EntityDuck extends Duck{static getInitialState({entity:t}){const e=t.dataToRecord({});return Map$1({detail:Map$1({[getIdentifier({id:null,useId:!0})]:e}),detail_dirty:Map$1({[getIdentifier({id:null,useId:!0})]:e}),errors:Map$1(),list:Map$1(),list_dirty:Map$1(),options:Map$1(),status:Map$1({deleting:Map$1(),deletingDidFail:Map$1(),getting:Map$1(),gettingDidFail:Map$1(),optioning:Map$1(),optioningDidFail:Map$1(),saving:Map$1(),savingDidFail:Map$1()})})}static getReducers(t,e){return _objectSpread({},reducerClear(t,e),reducerGet(t,e),reducerOptions(t,e),reducerSave(t,e),reducerDelete(t,e))}constructor(t){super(t)}errors(t,e){return t.getIn([this.app,this.constructor.namespace,this.entity.name,"errors",getIdentifier(e)])}record(t,e={}){return t.getIn([this.app,this.constructor.namespace,this.entity.name,`${void 0===e.id?"list":"detail"}${e.dirty?"_dirty":""}`,getIdentifier(Object.assign({method:"get",useId:!0},e)),...void 0===e.id&&this.entity.paginated?["results"]:[]])}meta(t,e){return t.getIn([this.app,this.constructor.namespace,this.entity.name,"options",getIdentifier(Object.assign({method:"options"},e))])}pagination(t,e){const i=t.getIn([this.app,this.constructor.namespace,this.entity.name,"list",getIdentifier(Object.assign({method:"get"},e))]);return i&&i.remove("results")}status(t,e){return t.getIn([this.app,this.constructor.namespace,this.entity.name,"status",e.status,getIdentifier(e)],!1)}hasPermissions(t,e){const i=t.getIn([this.app,this.constructor.namespace,this.entity.name,"options",getIdentifier(e),"permissions"],List());return!!(Array.isArray(e.permissions)?e.permissions:[e.permissions]).find(t=>i.includes(t))}}_defineProperty(EntityDuck,"namespace","entities"),_defineProperty(EntityDuck,"actions",{clear:Duck.createAction(),delete_rejected:Duck.createAction(),delete_resolved:Duck.createAction(),delete:Duck.createAction({defaultMeta:({entity:t,payload:e})=>({id:t.getId(e),keyProcessing:"deleting",keyProcessingDidFail:"deletingDidFail",method:"delete",params:Map$1(),useEntityMiddleware:!0})}),get_rejected:Duck.createAction(),get_resolved:Duck.createAction(),get:Duck.createAction({defaultMeta:({payload:t})=>({keyClear:"clear",keyPagination:"pagination",keyProcessing:"getting",keyProcessingDidFail:"gettingDidFail",keyRecord:"record",keySave:"save",keyStatus:"status",method:"get",params:Map$1(),useEntityMiddleware:null!==t.id}),meta:({payload:t})=>t,payload:()=>void 0}),options_rejected:Duck.createAction(),options_resolved:Duck.createAction(),options:Duck.createAction({defaultMeta:{method:"options",params:Map$1(),useEntityMiddleware:!0},meta:({payload:t})=>t,payload:()=>void 0}),save_rejected:Duck.createAction(),save_resolved:Duck.createAction(),save:Duck.createAction({defaultMeta:({entity:t,payload:e,options:i={}})=>({id:t.getId(e)||null,keyProcessing:"saving",keyProcessingDidFail:"savingDidFail",method:t.getId(e)?"put":"post",params:Map$1(),useEntityMiddleware:!i.dirty})})});export default EntityDuck;
